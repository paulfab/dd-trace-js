'use strict'

const { storage } = require('../../../../../datadog-core')
const { getFirstNonDDPathAndLine } = require('../path-line')
const { createVulnerability, addVulnerability } = require('../vulnerability-reporter')
const { getIastContext } = require('../iast-context')
const overheadController = require('../overhead-controller')
const IastPlugin = require('../iast-plugin')
const { INSTRUMENTED_SINK, EXECUTED_SINK } = require('../telemetry/metrics')

class Analyzer extends IastPlugin {
  constructor (type) {
    super(INSTRUMENTED_SINK, EXECUTED_SINK, type)
    this._type = type
  }

  _isVulnerable (value, context) {
    return false
  }

  _report (value, context) {
    const evidence = this._getEvidence(value, context)
    const location = this._getLocation()
    const spanId = context && context.rootSpan && context.rootSpan.context().toSpanId()
    const vulnerability = createVulnerability(this._type, evidence, spanId, location)
    addVulnerability(context, vulnerability)
  }

  _reportIfVulnerable (value, context) {
    if (this._isVulnerable(value, context) && this._checkOCE(context)) {
      this._report(value, context)
      return true
    }
    return false
  }

  _getEvidence (value) {
    return { value }
  }

  _getLocation () {
    return getFirstNonDDPathAndLine()
  }

  analyze (value) {
    const iastContext = getIastContext(storage.getStore())
    if (!iastContext) return

    this._reportIfVulnerable(value, iastContext)
  }

  analyzeAll (...values) {
    const iastContext = getIastContext(storage.getStore())
    if (!iastContext) return

    for (let i = 0; i < values.length; i++) {
      const value = values[i]
      if (this._isVulnerable(value, iastContext)) {
        if (this._checkOCE(iastContext)) {
          this._report(value, iastContext)
        }
        break
      }
    }
  }

  _checkOCE (context) {
    return overheadController.hasQuota(overheadController.OPERATIONS.REPORT_VULNERABILITY, context)
  }

  getExecutedMetricTag () {
    return this._type
  }
}

module.exports = Analyzer
